version: v1.0
name: Pipeline example
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: "Code analysis"
    task:
      jobs:
        - name: Flake8
          commands:
            - checkout
            - echo "Running flake8..."
            - pip3 install flake8
            - flake8 --statistics
            - echo "done."
        - name: Mypy
          commands:
            - checkout
            - echo "Running mypy..."
            - pip3 install mypy
            - mypy .
            - echo "done."
        - name: Pylint
          commands:
            - checkout
            - echo "Running pylint..."
            - pip3 install pylint
            - pylint src tests
            - echo "done."
        - name: Bandit
          commands:
            - checkout
            - echo "Running bandit..."
            - pip3 install bandit
            - bandit .
            - echo "done."
  - name: "Build"
    task:
      jobs:
      - name: Docker build
        commands:
          - checkout
          - echo "Build docker image..."
          - docker build -t calculator -f devops/Dockerfile .
          - echo "Image built."

  - name: "Tests"
    task:
      jobs:
        - name: Pytest
          commands:
            - checkout
            - echo "Running pytest..."
            - pip3 install pytest pytest-cov
            - pytest -v --cov
            - echo "done."
