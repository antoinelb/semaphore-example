version: v1.0
name: First pipeline example
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: "Code analysis"
    task:
      jobs:
        - name: Flake8
          commands:
            - checkout
            - echo "Running flake8..."
            - flake8 --statistics
            - echo "done."
        - name: Mypy
          commands:
            - checkout
            - echo "Running mypy..."
            - mypy .
            - echo "done."
        - name: Pylint
          commands:
            - checkout
            - echo "Running pylint..."
            - pylint src tests
            - echo "done."
        - name: Bandit
          commands:
            - checkout
            - echo "Running bandit..."
            - bandit .
            - echo "done."
  - name: "Build"
    task:
      env_vars:
        - name: APP_ENV
          value: dev
      jobs:
      - name: Docker build
        commands:
          - checkout
          - ls -1
          - echo $APP_ENV
          - echo "Build docker image..."
          - docker build -t calculator -f devops/Dockerfile .
          - echo "Image built."

  - name: "Tests"
    task:
      jobs:
        - name: Pytest
          commands:
            - checkout
            - echo "Running pytest..."
            - pytest -v --cov
            - echo: "done."
